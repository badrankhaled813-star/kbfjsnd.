<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ù…Ø·Ø¹Ù… Ø§Ù„Ø¬Ø²ÙŠØ±Ø© - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1a1d21; color: white; padding: 20px; direction: rtl; }
        .form-box { background: #ffffff; color: #333; padding: 25px; border-radius: 15px; max-width: 600px; margin: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h2 { text-align: center; color: #2ea44f; }
        label { font-weight: bold; display: block; margin-top: 15px; }
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }

        .variations-container { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        .var-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .var-row input { margin: 0; }

        .add-var-btn { background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; margin-bottom: 10px; }

        #saveBtn { width: 100%; padding: 15px; background: #2ea44f; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 18px; margin-top: 20px; }
        #saveBtn:disabled { background: #ccc; }
        #status { text-align: center; margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="form-box">
        <h2>Ø¥Ø¶Ø§ÙØ© Ø·Ø¨Ù‚ Ø§Ø­ØªØ±Ø§ÙÙŠ âœ¨</h2>

        <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø¨Ù‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ:</label>
        <input type="text" id="itemName" placeholder="Ù…Ø«Ù„Ø§Ù‹: ÙˆØ¬Ø¨Ø§Øª Ø¥ÙŠØ·Ø§Ù„ÙŠ">

        <label>Ø§Ù„ØªØµÙ†ÙŠÙ:</label>
        <select id="itemCategory">
            <option value="Ø§Ù„Ø´Ø§ÙˆØ±Ù…Ø§">Ø§Ù„Ø´Ø§ÙˆØ±Ù…Ø§</option>
            <option value="Ø§Ù„Ù…Ø´ÙˆÙŠØ§Øª">Ø§Ù„Ù…Ø´ÙˆÙŠØ§Øª</option>
            <option value="Ø§Ù„Ù…Ù‚Ø¨Ù„Ø§Øª">Ø§Ù„Ù…Ù‚Ø¨Ù„Ø§Øª</option>
            <option value="Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª">Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª</option>
        </select>

        <label>ÙˆÙ‚Øª Ø§Ù„ØªØ­Ø¶ÙŠØ± (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚):</label>
        <input type="number" id="prepTime" placeholder="Ù…Ø«Ù„Ø§Ù‹: 20">

        <label>ÙˆØµÙ Ù…Ø®ØªØµØ±:</label>
        <textarea id="itemDesc" placeholder="ÙˆØµÙ Ø§Ù„Ø·Ø¨Ù‚..."></textarea>

        <label>Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø± (Ù…Ø«Ù„Ø§Ù‹: Ø¹Ø§Ø¯ÙŠ - 2.75):</label>
        <div class="variations-container" id="varsContainer">
            <div class="var-row">
                <input type="text" class="var-name" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± (Ø³ÙˆØ¨Ø±)">
                <input type="number" step="0.01" class="var-price" placeholder="Ø§Ù„Ø³Ø¹Ø±">
            </div>
        </div>
        <button type="button" class="add-var-btn" onclick="addVariationRow()">+ Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± Ø³Ø¹Ø± Ø¢Ø®Ø±</button>

        <label>ØµÙˆØ±Ø© Ø§Ù„Ø·Ø¨Ù‚:</label>
        <input type="file" id="itemImg" accept="image/*">

        <button id="saveBtn">Ù†Ø´Ø± Ø§Ù„Ø·Ø¨Ù‚ ÙÙŠ Ø§Ù„Ù…Ù†ÙŠÙˆ</button>
        <div id="status"></div>
    </div>

    <script>
        const GITHUB_TOKEN = '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';
        const REPO_OWNER = 'badrankhaled813-star';
        const REPO_NAME = 'kbfjsnd.';
        const DATA_FILE_PATH = 'data.json';
        const IMAGE_FOLDER = 'uploads/';

        function addVariationRow() {
            const container = document.getElementById('varsContainer');
            const row = document.createElement('div');
            row.className = 'var-row';
            row.innerHTML = `
                <input type="text" class="var-name" placeholder="Ø§Ù„Ø®ÙŠØ§Ø±">
                <input type="number" step="0.01" class="var-price" placeholder="Ø§Ù„Ø³Ø¹Ø±">
            `;
            container.appendChild(row);
        }

        document.getElementById('saveBtn').onclick = async () => {
            const name = document.getElementById('itemName').value;
            const category = document.getElementById('itemCategory').value;
            const prepTime = document.getElementById('prepTime').value;
            const desc = document.getElementById('itemDesc').value;
            const file = document.getElementById('itemImg').files[0];
            const btn = document.getElementById('saveBtn');
            const status = document.getElementById('status');

            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
            const varNames = document.querySelectorAll('.var-name');
            const varPrices = document.querySelectorAll('.var-price');
            let variations = {};
            varNames.forEach((input, index) => {
                if(input.value) variations[input.value] = parseFloat(varPrices[index].value);
            });

            if (!name || Object.keys(variations).length === 0 || !file) {
                return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø³Ø¹Ø±ØŒ Ø§Ù„ØµÙˆØ±Ø©)");
            }

            btn.disabled = true;
            status.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹ Ø¥Ù„Ù‰ GitHub...";

            try {
                const base64Img = await toBase64(file);
                const imgFileName = Date.now() + "_" + file.name;
                const imgPath = IMAGE_FOLDER + imgFileName;

                // 1. Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©
                await uploadToGithub(imgPath, base64Img.split(',')[1], `ØµÙˆØ±Ø©: ${name}`);

                // 2. ØªØ­Ø¯ÙŠØ« JSON
                const currentData = await fetchCurrentData();
                const newItem = {
                    id: Date.now(),
                    name: name,
                    category: category,
                    prepTime: prepTime,
                    description: desc,
                    image: `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/${imgPath}`,
                    variations: variations, // Ù‡Ø°Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
                    minPrice: Math.min(...Object.values(variations)) // Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ø¹Ø±Ø¶ "ÙŠØ¨Ø¯Ø£ Ù…Ù†"
                };

                currentData.push(newItem);
                const updatedJson = btoa(unescape(encodeURIComponent(JSON.stringify(currentData, null, 2))));
                await uploadToGithub(DATA_FILE_PATH, updatedJson, `Ø¥Ø¶Ø§ÙØ© Ø·Ø¨Ù‚: ${name}`, true);

                status.style.color = "green";
                status.innerText = "ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰";
                setTimeout(() => location.reload(), 2000);

            } catch (err) {
                alert("Ø®Ø·Ø£: " + err.message);
                btn.disabled = false;
            }
        };

        // Ø¯Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© (Ù†ÙØ³Ù‡Ø§ Ø§Ù„ØªÙŠ Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§Ù‡Ø§ Ø³Ø§Ø¨Ù‚Ø§Ù‹)
        async function uploadToGithub(path, content, message, isJson = false) {
            let sha = "";
            if (isJson) {
                const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`, {
                    headers: { "Authorization": `token ${GITHUB_TOKEN}` }
                });
                if (res.ok) { const data = await res.json(); sha = data.sha; }
            }
            const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`, {
                method: "PUT",
                headers: { "Authorization": `token ${GITHUB_TOKEN}`, "Content-Type": "application/json" },
                body: JSON.stringify({ message, content, sha: sha || undefined })
            });
            if (!response.ok) throw new Error("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹");
        }

        async function fetchCurrentData() {
            const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE_PATH}`, {
                headers: { "Authorization": `token ${GITHUB_TOKEN}` }
            });
            if (!res.ok) return [];
            const data = await res.json();
            return JSON.parse(decodeURIComponent(escape(atob(data.content))));
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    </script>
</body>
</html>
